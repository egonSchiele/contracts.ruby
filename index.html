<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Contracts.ruby by egonSchiele</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Contracts.ruby</h1>
        <p>Contracts for Ruby</p>
        <p class="view"><a href="https://github.com/egonSchiele/contracts.ruby">View the Project on GitHub <small>egonSchiele/contracts.ruby</small></a></p>
        <ul>
          <li><a href="https://github.com/egonSchiele/contracts.ruby/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/egonSchiele/contracts.ruby/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/egonSchiele/contracts.ruby">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="the-contractsruby-tutorial" class="anchor" href="#the-contractsruby-tutorial"><span class="octicon octicon-link"></span></a>The contracts.ruby tutorial</h1>

<h2>
<a name="introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h2>

<p>contracts.ruby brings code contracts to the Ruby language. Code contracts allow you make some assertions about your code, and then checks them to make sure they hold. This lets you</p>

<ul>
<li>catch bugs faster</li>
<li>make it very easy to catch certain types of bugs</li>
<li>make sure that the user gets proper messaging when a bug occurs.</li>
</ul><h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<pre><code>gem install contracts
</code></pre>

<h2>
<a name="basics" class="anchor" href="#basics"><span class="octicon octicon-link"></span></a>Basics</h2>

<p>A simple example:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Num</span><span class="p">,</span> <span class="no">Num</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
   <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
 <span class="k">end</span>
</pre></div>

<p>Here, the contract is <code>Contract Num, Num =&gt; Num</code>. This says that the <code>add</code> function takes two numbers and returns a number.</p>

<p>Copy this code into a file and run it:</p>

<div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'contracts'</span>
<span class="kp">include</span> <span class="no">Contracts</span>

<span class="no">Contract</span> <span class="no">Num</span><span class="p">,</span> <span class="no">Num</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
   <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">)</span>
</pre></div>

<p>You'll see a detailed error message like so:</p>

<pre><code>./contracts.rb:60:in `failure_callback': Contract violation: (RuntimeError)
    Expected: Contracts::Num,
    Actual: "foo"
    Value guarded in: Object::add
    With Contract: Contracts::Num, Contracts::Num
    At: foo.rb:6 
</code></pre>

<p>That tells you that your contract was violated! <code>add</code> expected a <code>Num</code>, and got a string (<code>"foo"</code>) instead.
By default, an exception is thrown when a contract fails. This can be changed to do whatever you want. More on this later.</p>

<p>You can also see the contract for a function with the <code>functype</code> method:</p>

<pre><code>functype(:add)
=&gt; "add :: Num, Num =&gt; Num"
</code></pre>

<p>This can be useful if you're in a repl and want to figure out how a function should be used.</p>

<h2>
<a name="builtin-contracts" class="anchor" href="#builtin-contracts"><span class="octicon octicon-link"></span></a>Builtin Contracts</h2>

<p><code>Num</code> is one of the builtin contracts that contracts.ruby comes with. The builtin contracts are in the <code>Contracts</code> namespace. The easiest way to use them is to put <code>include Contracts</code> at the top of your file, but beware that they will pollute your namespace with new class names.</p>

<p>contracts.ruby comes with a lot of builtin contracts, including:</p>

<pre><code>Num, Pos, Neg, Any, None, Or, Xor, And, Not, RespondTo, Send, Exactly, ArrayOf, HashOf, Bool, Maybe
</code></pre>

<p>To see all the builtin contracts and what they do, check out the <a href="http://rubydoc.info/gems/contracts/Contracts">rdoc</a>.</p>

<h2>
<a name="more-examples" class="anchor" href="#more-examples"><span class="octicon octicon-link"></span></a>More Examples</h2>

<h3>
<a name="hello-world" class="anchor" href="#hello-world"><span class="octicon octicon-link"></span></a>Hello, World</h3>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="nb">String</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"hello, </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</pre></div>

<p>You always need to specify a contract for the return value. In this example, <code>hello</code> doesn't return anything, so the contract is <code>nil</code>. Now you know that you can use a constant like <code>nil</code> as the of a contract. Valid values for a contract are:</p>

<ul>
<li>the name of a class (like <code>String</code> or <code>Fixnum</code>)</li>
<li>a constant (like <code>nil</code> or <code>1</code>)</li>
<li>a <code>Proc</code> that takes a value and returns true or false to indicate whether the contract passed or not</li>
<li>a class that responds to the <code>valid?</code> class method (more on this later)</li>
<li>an instance of a class that responds to the <code>valid?</code> method (more on this later)</li>
</ul><h3>
<a name="a-double-function" class="anchor" href="#a-double-function"><span class="octicon octicon-link"></span></a>A Double Function</h3>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Or</span><span class="o">[</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="no">Or</span><span class="o">[</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="o">]</span>
<span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>
<span class="k">end</span>
</pre></div>

<p>Sometimes you want to be able to choose between a few contracts. <code>Or</code> takes a variable number of contracts and checks the argument against all of them. If it passes for any of the contracts, then the <code>Or</code> contract passes.
This introduces some new syntax. One of the valid values for a contract is an instance of a class that responds to the <code>valid?</code> method. This is what <code>Or[Fixnum, Float]</code> is. The longer way to write it would have been:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Or</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="no">Or</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="p">)</span>
</pre></div>

<p>All the builtin contracts have overridden the square brackets (<code>[]</code>) to give the same functionality. So you could write</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Or</span><span class="o">[</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="no">Or</span><span class="o">[</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="o">]</span>
</pre></div>

<p>or</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Or</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="no">Or</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="p">)</span>
</pre></div>

<p>whichever you prefer. They both mean the same thing here: make a new instance of <code>Or</code> with <code>Fixnum</code> and <code>Float</code>. Use that instance to validate the argument.</p>

<h3>
<a name="a-product-function" class="anchor" href="#a-product-function"><span class="octicon octicon-link"></span></a>A Product Function</h3>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">ArrayOf</span><span class="o">[</span><span class="no">Num</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
  <span class="n">total</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">vals</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span>
    <span class="n">total</span> <span class="o">*=</span> <span class="n">val</span>
  <span class="k">end</span>
  <span class="n">total</span>
<span class="k">end</span>
</pre></div>

<p>This contract uses the <code>ArrayOf</code> contract. Here's how <code>ArrayOf</code> works: it takes a contract. It expects the argument to be a list. Then it checks every value in that list to see if it satisfies that contract.</p>

<div class="highlight highlight-ruby"><pre><span class="c1"># passes</span>
<span class="n">product</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span><span class="p">)</span>

<span class="c1"># fails</span>
<span class="n">product</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"foo"</span><span class="o">]</span><span class="p">)</span>
</pre></div>

<h3>
<a name="another-product-function" class="anchor" href="#another-product-function"><span class="octicon octicon-link"></span></a>Another Product Function</h3>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Args</span><span class="o">[</span><span class="no">Num</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">)</span>
  <span class="n">total</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">vals</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span>
    <span class="n">total</span> <span class="o">*=</span> <span class="n">val</span>
  <span class="k">end</span>
  <span class="n">total</span>
<span class="k">end</span>
</pre></div>

<p>This function uses varargs (<code>*args</code>) instead of an array. To make a contract on varargs, use the <code>Args</code> contract. It takes one contract as an argument and uses it to validate every element passed in through <code>*args</code>. So for example,</p>

<p><code>Args[Num]</code> means they should all be numbers. </p>

<p><code>Args[Or[Num, String]]</code> means they should all be numbers or strings.</p>

<p><code>Args[Any]</code> means all arguments are allowed (<code>Any</code> is a contract that passes for any argument).</p>

<h3>
<a name="contracts-on-arrays" class="anchor" href="#contracts-on-arrays"><span class="octicon octicon-link"></span></a>Contracts On Arrays</h3>

<p>If an array is one of the arguments and you know how many elements it's going to have, you can put a contract on it:</p>

<div class="highlight highlight-ruby"><pre><span class="c1"># a function that takes an array of two elements...a person's age and a person's name.</span>
<span class="no">Contract</span> <span class="o">[</span><span class="no">Num</span><span class="p">,</span> <span class="nb">String</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="k">def</span> <span class="nf">person</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="nb">p</span> <span class="n">data</span>
<span class="k">end</span>
</pre></div>

<p>If you don't know how many elements it's going to have, use <code>ArrayOf</code>.</p>

<h3>
<a name="contracts-on-hashes" class="anchor" href="#contracts-on-hashes"><span class="octicon octicon-link"></span></a>Contracts On Hashes</h3>

<p>Here's a contract that requires a Hash. We can put contracts on each of the keys:</p>

<div class="highlight highlight-ruby"><pre><span class="c1"># note the parentheses around the hash; without those you would get a syntax error</span>
<span class="no">Contract</span> <span class="p">({</span> <span class="ss">:age</span> <span class="o">=&gt;</span> <span class="no">Num</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="nb">String</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="k">def</span> <span class="nf">person</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="nb">p</span> <span class="n">data</span>
<span class="k">end</span>
</pre></div>

<p>Then if someone tries to call the function with bad data, it will fail:</p>

<div class="highlight highlight-ruby"><pre><span class="c1"># error: age can't be nil!</span>
<span class="n">person</span><span class="p">({</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Adit"</span><span class="p">,</span> <span class="ss">:age</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">})</span>
</pre></div>

<p>You don't need to put a contract on every key. So this call would succeed:</p>

<div class="highlight highlight-ruby"><pre><span class="n">person</span><span class="p">({</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Adit"</span><span class="p">,</span> <span class="ss">:age</span> <span class="o">=&gt;</span> <span class="mi">42</span><span class="p">,</span> <span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="s2">"bar"</span><span class="p">})</span>
</pre></div>

<p>even though we don't specify a type for <code>:foo</code>.</p>

<p>Peruse this contract on the keys and values of a Hash.</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">HashOf</span><span class="o">[</span><span class="no">Symbol</span><span class="p">,</span> <span class="no">Num</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">give_largest_value</span><span class="p">(</span><span class="n">hsh</span><span class="p">)</span>
  <span class="n">hsh</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
<span class="k">end</span>
</pre></div>

<p>Which you use like so:</p>

<div class="highlight highlight-ruby"><pre><span class="c1"># succeeds</span>
<span class="n">give_largest_value</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># returns 3</span>

<span class="c1"># fails</span>
<span class="n">give_largest_value</span><span class="p">(</span><span class="s2">"a"</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

<h3>
<a name="contracts-on-functions" class="anchor" href="#contracts-on-functions"><span class="octicon octicon-link"></span></a>Contracts On Functions</h3>

<p>If you're writing higher-order functions (functions that take functions as parameters) and want to write a contract for the passed-in function, you can!
Use the <code>Func</code> contract. <code>Func</code> takes a contract as it's argument, and uses that contract on the function that you pass in.</p>

<p>Here's a <code>map</code> function that requires an array of numbers, and a function that takes a number and returns a number:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">ArrayOf</span><span class="o">[</span><span class="no">Num</span><span class="o">]</span><span class="p">,</span> <span class="no">Func</span><span class="o">[</span><span class="no">Num</span> <span class="o">=&gt;</span> <span class="no">Num</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="no">ArrayOf</span><span class="o">[</span><span class="no">Num</span><span class="o">]</span>
<span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="n">arr</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
    <span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="n">func</span><span class="o">[</span><span class="n">x</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="n">ret</span>
<span class="k">end</span>
</pre></div>

<p>This will add the contract <code>Num =&gt; Num</code> on <code>func</code>. Try it with these two examples:</p>

<div class="highlight highlight-ruby"><pre><span class="nb">p</span> <span class="n">map</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">})</span> <span class="c1"># works</span>
<span class="nb">p</span> <span class="n">map</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="s2">"oops"</span> <span class="p">})</span> <span class="c1"># fails, the lambda returns a string.</span>
</pre></div>

<h3>
<a name="returning-multiple-values" class="anchor" href="#returning-multiple-values"><span class="octicon octicon-link"></span></a>Returning Multiple Values</h3>

<p>Treat the return value as an array. For example, here's a function that returns two numbers:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Num</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="no">Num</span><span class="p">,</span> <span class="no">Num</span><span class="o">]</span>
<span class="k">def</span> <span class="nf">mult</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="synonyms-for-contracts" class="anchor" href="#synonyms-for-contracts"><span class="octicon octicon-link"></span></a>Synonyms For Contracts</h2>

<p>If you use a contract a lot, it's a good idea to give it a meaningful synonym that tells the reader more about what your code returns. For example, suppose you have many functions that return a <code>Hash</code> or <code>nil</code>. If a <code>Hash</code> is returned, it contains information about a person. Your contact might look like this:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="nb">String</span> <span class="o">=&gt;</span> <span class="no">Or</span><span class="o">[</span><span class="no">Hash</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
<span class="k">def</span> <span class="nf">some_func</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
</pre></div>

<p>You can make your contract more meaningful with a synonym:</p>

<div class="highlight highlight-ruby"><pre><span class="c1"># the synonym</span>
<span class="no">Person</span> <span class="o">=</span> <span class="no">Or</span><span class="o">[</span><span class="no">Hash</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>

<span class="c1"># use the synonym here</span>
<span class="no">Contract</span> <span class="nb">String</span> <span class="o">=&gt;</span> <span class="no">Person</span>
<span class="k">def</span> <span class="nf">some_func</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
</pre></div>

<p>Now you can use <code>Person</code> wherever you would have used <code>Or[Hash, nil]</code>. Your code is now cleaner and more clearly says what the function is doing.</p>

<h2>
<a name="defining-your-own-contracts" class="anchor" href="#defining-your-own-contracts"><span class="octicon octicon-link"></span></a>Defining Your Own Contracts</h2>

<p>Contracts are very easy to define. To re-iterate, there are 5 kinds of contracts:</p>

<ul>
<li>the name of a class (like <code>String</code> or <code>Fixnum</code>)</li>
<li>a constant (like <code>nil</code> or <code>1</code>)</li>
<li>a <code>Proc</code> that takes a value and returns true or false to indicate whether the contract passed or not</li>
<li>a class that responds to the <code>valid?</code> class method (more on this later)</li>
<li>an instance of a class that responds to the <code>valid?</code> method (more on this later)</li>
</ul><p>The first two don't need any extra work to define: you can just use any constant or class name in your contract and it should just work. Here are examples for the rest:</p>

<h3>
<a name="a-proc" class="anchor" href="#a-proc"><span class="octicon octicon-link"></span></a>A Proc</h3>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Numeric</span> <span class="p">}</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

<p>The lambda takes one parameter: the argument that is getting passed to the function. It checks to see if it's a <code>Numeric</code>. If it is, it returns true. Otherwise it returns false.
It's not good practice to write a lambda right in your contract...if you find yourself doing it often, write it as a class instead:</p>

<h3>
<a name="a-class-with-valid-as-a-class-method" class="anchor" href="#a-class-with-valid-as-a-class-method"><span class="octicon octicon-link"></span></a>A Class With <code>valid?</code> As a Class Method</h3>

<p>Here's how the <code>Num</code> class is defined. It does exactly what the <code>lambda</code> did in the previous example:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Num</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">valid?</span> <span class="n">val</span>
    <span class="n">val</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Numeric</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The <code>valid?</code> class method takes one parameter: the argument that is getting passed to the function. It returns true or false.</p>

<h3>
<a name="a-class-with-valid-as-an-instance-method" class="anchor" href="#a-class-with-valid-as-an-instance-method"><span class="octicon octicon-link"></span></a>A Class With <code>valid?</code> As an Instance Method</h3>

<p>Here's how the <code>Or</code> class is defined:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Or</span> <span class="o">&lt;</span> <span class="no">CallableClass</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">)</span>
    <span class="vi">@vals</span> <span class="o">=</span> <span class="n">vals</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">valid?</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="vi">@vals</span><span class="o">.</span><span class="n">any?</span> <span class="k">do</span> <span class="o">|</span><span class="n">contract</span><span class="o">|</span>
      <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="no">Contract</span><span class="o">.</span><span class="n">valid?</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">contract</span><span class="p">)</span>
      <span class="n">res</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The <code>Or</code> contract takes a sequence of contracts, and passes if any of them pass. It uses <code>Contract.valid?</code> to validate the value against the contracts.</p>

<p>This class inherits from <code>CallableClass</code>, which allows us to use <code>[]</code> when using the class:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Or</span><span class="o">[</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>
<span class="k">end</span>
</pre></div>

<p>Without <code>CallableClass</code>, we would have to use <code>.new</code> instead:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Or</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Fixnum</span><span class="p">,</span> <span class="nb">Float</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1"># etc</span>
</pre></div>

<p>You can use <code>CallableClass</code> in your own contracts to make them callable using <code>[]</code>.</p>

<h2>
<a name="customizing-error-messages" class="anchor" href="#customizing-error-messages"><span class="octicon octicon-link"></span></a>Customizing Error Messages</h2>

<p>When a contract fails, part of the error message prints the contract:</p>

<pre><code>...
Expected: Contracts::Num,
...
</code></pre>

<p>You can customize this message by overriding the <code>to_s</code> method on your class or proc. For example, suppose we overrode <code>Num</code>'s <code>to_s</code> method:</p>

<div class="highlight highlight-ruby"><pre><span class="k">def</span> <span class="nc">Num</span><span class="o">.</span><span class="nf">to_s</span>
  <span class="s2">"a number please"</span>
<span class="k">end</span>
</pre></div>

<p>Now the error says:</p>

<pre><code>...
Expected: a number please,
...
</code></pre>

<h2>
<a name="failure-callbacks" class="anchor" href="#failure-callbacks"><span class="octicon octicon-link"></span></a>Failure Callbacks</h2>

<p>Supposing you don't want contract failures to become exceptions. You run a popular website, and when there's a contract exception you would rather log it and continue than throw an exception and break your site.</p>

<p>contracts.ruby provides a <code>failure_callback</code> that gets called when a contract fails. By monkeypatching <code>failure_callback</code>, you can customize the behavior of contracts.ruby. For example, here we log every failure instead of raising an error:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Contract</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">failure_callback</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">info</span> <span class="n">failure_msg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p><code>failure_msg</code> is a function that prints out information about the failure. <code>failure_callback</code> takes a hash with the following values:</p>

<pre><code>{
  :arg =&gt; the argument to the method,
  :contract =&gt; the contract that got violated,
  :class =&gt; the method's class,
  :method =&gt; the method,
  :contracts =&gt; the contract object
}
</code></pre>

<p>If <code>failure_callback</code> returns <code>false</code>, the method that the contract is guarding will not be called (the default behaviour).</p>

<h2>
<a name="method-overloading" class="anchor" href="#method-overloading"><span class="octicon octicon-link"></span></a>Method overloading</h2>

<p>You can use contracts for method overloading! For example, here's a factorial function without method overloading:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="no">Num</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">fact</span> <span class="n">x</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">x</span>
  <span class="k">else</span>
    <span class="n">x</span> <span class="o">*</span> <span class="n">fact</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Here it is again, re-written with method overloading:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Contract</span> <span class="mi">1</span> <span class="o">=&gt;</span> <span class="mi">1</span>
<span class="k">def</span> <span class="nf">fact</span> <span class="n">x</span>
  <span class="n">x</span>
<span class="k">end</span>

<span class="no">Contract</span> <span class="no">Num</span> <span class="o">=&gt;</span> <span class="no">Num</span>
<span class="k">def</span> <span class="nf">fact</span> <span class="n">x</span>
  <span class="n">x</span> <span class="o">*</span> <span class="n">fact</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>For an argument, each function will be tried in order. The first function that doesn't raise a <code>ContractError</code> will be used. So in this case, if x == 1, the first function will be used. For all other values, the second function will be used.</p>

<h2>
<a name="misc" class="anchor" href="#misc"><span class="octicon octicon-link"></span></a>Misc</h2>

<p>Please submit any bugs <a href="https://github.com/egonSchiele/contracts.ruby/issues">here</a> and I'll try to get them resolved ASAP!</p>

<p>See any mistakes in this tutorial? I try to make it bug-free, but they can creep in. <a href="https://github.com/egonSchiele/contracts.ruby/issues">File an issue</a>.</p>

<p>If you're using the library, please <a href="https://github.com/egonSchiele">let me know</a> what project you're using it on :)</p>

<p>See the <a href="https://github.com/egonSchiele/contracts.ruby/wiki">wiki</a> for more info.</p>

<p>Happy Coding!</p>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/egonSchiele">egonSchiele</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-32498338-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>